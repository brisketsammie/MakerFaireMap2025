<!DOCTYPE html>
<html>
<head>
  <title>Library Visitors Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 100vh; }

    #controls {
      position: absolute;
      top: 60px;
      left: 10px;
      z-index: 1000;
      background: rgba(255,255,255,0.85);
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    #controls button {
      display: block;
      margin: 6px 0;
      width: 140px;
      padding: 10px;
      border: none;
      border-radius: 6px;
      background: linear-gradient(to right, #0077cc, #005fa3);
      color: white;
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    #controls button:hover {
      background: linear-gradient(to right, #005fa3, #003f73);
    }
    
  </style>
</head>
<body>
<div id="controls">
  <button onclick="toggleView('pins')">Show Pins</button>
  <button onclick="toggleView('zipHeatmap')">Show Zip Code Heatmap</button>
</div>
<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ0LuoEAt5aBA4fetdRj_bj0inLdIReDAMMP8mT6jHdaErZh7lmZqtDUlDmtdlwuKFQpTwILYmzHPJh/pub?output=csv';

  let map;
  let pinLayer;
  let zipHeatLayer;

  function getColor(value, max) {
    const percent = value / max;
    return percent > 0.80 ? '#006d2c' :
           percent > 0.60 ? '#338d5b' :
           percent > 0.40 ? '#66ad89' :
           percent > 0.20 ? '#99ccb8' :
           percent > 0    ? '#ccece6' :
                            '#F0F0F0';
  }

  async function loadData() {
    const response = await fetch(sheetURL);
    const text = await response.text();
    const rows = text.split('\n').slice(1); // Skip header

    return rows
      .map(row => row.split(','))
      .filter(cols => cols.length >= 6 && cols[4] && cols[5])
      .map(cols => {
        const country = cols[1].trim();
        const usZip = cols[2].trim();
        const caPostal = cols[3].trim();
        const lat = parseFloat(cols[4]);
        const lon = parseFloat(cols[5]);
        const code = country === 'US' ? usZip : caPostal;
        return { country, code, lat, lon };
      });
  }

  async function createMap() {
    map = L.map('map').setView([43.0702, -76.2176], 8); // Center on your region

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap & Carto',
      subdomains: 'abcd'
    }).addTo(map);

    // County lines
    fetch('https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json')
      .then(response => response.json())
      .then(geojson => {
        L.geoJSON(geojson, {
          style: {
            color: "#444",
            weight: 0.5,
            fillOpacity: 0,
            opacity: 0.3
          }
        }).addTo(map);
      });

    const data = await loadData();
    const zipCounts = {};
    data.forEach(({ country, code }) => {
      const key = `${country}-${code}`;
      zipCounts[key] = (zipCounts[key] || 0) + 1;
    });

    const maxCount = Math.max(...Object.values(zipCounts));
    pinLayer = L.layerGroup();

    data.forEach(({ country, code, lat, lon }) => {
      const key = `${country}-${code}`;
      const count = zipCounts[key];
      L.circleMarker([lat, lon], {
        radius: 4,
        fillColor: country === 'Canada' ? '#ff6600' : '#0077cc',
        color: '#003366',
        fillOpacity: 0.7
      })
      .bindPopup(`${country} ${code}: ${count} visit(s)`)
      .addTo(pinLayer);
    });

    // ZIP heatmap
    fetch('zip_geojson.json')
      .then(response => response.json())
      .then(geojson => {
        zipHeatLayer = L.geoJSON(geojson, {
          style: feature => {
            const zip = feature.properties.ZCTA5CE10;
            const key = `US-${zip}`;
            const count = zipCounts[key] || 0;
            return {
              fillColor: getColor(count, maxCount),
              fillOpacity: 1,
              color: '#222',
              weight: 0.5,
              opacity: 0.3
            };
          },
          onEachFeature: (feature, layer) => {
            const zip = feature.properties.ZCTA5CE10;
            const key = `US-${zip}`;
            const count = zipCounts[key] || 0;
            if (count > 0) {
              layer.bindPopup(`ZIP ${zip}: ${count} visit(s)`);
            }
          }
        });

        const lastMode = localStorage.getItem('mapViewMode') || 'pins';
        if (lastMode === 'zipHeatmap') {
          zipHeatLayer.addTo(map);
        } else {
          pinLayer.addTo(map);
        }
      });

    // State lines
    fetch('https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json')
      .then(response => response.json())
      .then(stateGeo => {
        L.geoJSON(stateGeo, {
          style: {
            color: "#3432a8",
            weight: 1,
            opacity: 0.4,
            fillOpacity: 0
          }
        }).addTo(map);
      });
  }

  createMap();

  function toggleView(mode) {
    if (!zipHeatLayer || !pinLayer) return;
    if (mode === 'pins') {
      map.removeLayer(zipHeatLayer);
      map.addLayer(pinLayer);
    } else if (mode === 'zipHeatmap') {
      map.removeLayer(pinLayer);
      map.addLayer(zipHeatLayer);
    }
    localStorage.setItem('mapViewMode', mode);
  }

  // Auto-refresh every 60 seconds
  setInterval(() => {
    location.reload();
  }, 60000);
</script>

</body>
</html>
